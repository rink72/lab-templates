---
parameters:
  configPath: ""
  service: ""
  gcpKeyData: ""
  project: "labrink72"
  terragruntArtifactName: terragrunt
  infrastructureArtifactName: infrastructure
  apply: false
  timeout: 90

steps:
  - pwsh: |
      $environmentPath = "$(System.ArtifactsDirectory)/${{ parameters.terragruntArtifactName }}/terragrunt/gcp/${{ parameters.project }}/${{ parameters.service }}"
      $configPath = "$(System.ArtifactsDirectory)/${{ parameters.configPath }}"

      gci -recurse

      Write-Host "Artifact"

      gci $(System.ArtifactsDirectory)/ -Recurse

      New-Item `
        -Path $environmentPath `
        -ItemType Directory `
        -Force `
        -ErrorAction Stop | Out-Null

      Copy-Item `
        -Path $configPath `
        -Destination $environmentPath `
        -Force `
        -ErrorAction Stop

      gci $environmentPath -Recurse
    displayName: Merge terragrunt configuration

  - ${{ if eq(parameters.apply, false) }}:
      - pwsh: |
          $tempPath = [System.IO.Path]::GetTempPath()
          $keyPath = Join-Path -Path $tempPath -ChildPath "key.json"

          [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String('${{ parameters.gcpKeyData }}')) > $keyPath
          $env:GOOGLE_APPLICATION_CREDENTIALS = $keyPath

          gcloud auth activate-service-account --quiet --key-file $keyPath

          gci $(System.ArtifactsDirectory) -Recurse

          $(System.ArtifactsDirectory)/${{ parameters.terragruntArtifactName }}/terragrunt/scripts/Deploy-GCPTerragruntConfig.ps1 -Service ${{ parameters.service }}
        displayName: Terragrunt plan

  - ${{ else }}:
      - pwsh: |
          $tempPath = [System.IO.Path]::GetTempPath()
          $keyPath = Join-Path -Path $tempPath -ChildPath "key.json"

          [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String('${{ parameters.gcpKeyData }}')) > $keyPath
          $env:GOOGLE_APPLICATION_CREDENTIALS = $keyPath

          gcloud auth activate-service-account --quiet --key-file $keyPath

          $(System.ArtifactsDirectory)/${{ parameters.terragruntArtifactName }}/terragrunt/scripts/Deploy-GCPTerragruntConfig.ps1 -Service ${{ parameters.service }} -Apply
        displayName: Terragrunt apply

  - pwsh: |
      $tempPath = [System.IO.Path]::GetTempPath()
      $keyPath = Join-Path -Path $tempPath -ChildPath "key.json"
      Remove-Item -Path $keyPath -Force
    displayName: Cleanup
    condition: always()
