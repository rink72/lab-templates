---
parameters:
  ansibleArtifactName: ansible
  ansiblePlaybook: ""
  service: ""
  sshKeyExpiry: "60m"
  gcpKeyData: ""
  apply: false
  timeout: 90

steps:
  - pwsh: |
      $tempPath = [System.IO.Path]::GetTempPath()
      $keyPath = Join-Path -Path $tempPath -ChildPath "key.json"

      [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String('${{ parameters.gcpKeyData }}')) > $keyPath
      $env:GOOGLE_APPLICATION_CREDENTIALS = $keyPath

      gcloud auth activate-service-account --quiet --key-file $keyPath

    displayName: Create temporary SSH key

  - pwsh: |
      $env:ANSIBLE_CONFIG = $(Pipeline.Workspace)/${{ parameters.ansibleArtifactName }}/ansible.cfg
      $env:GCE_CREDENTIALS_FILE_PATH = Join-Path -Path $tempPath -ChildPath "key.json"

      Set-Location
        -Path $(Pipeline.Workspace)/${{ parameters.ansibleArtifactName }} `
        -ErrorAction Stop | Out-Null

      ansible-inventory -i inventories/inventory.gcp.yml  --graph

    displayName: Run ansible

  - pwsh: |
      Remove-Item -Path "$($env:TEMP)/key.json" -Force
    displayName: Cleanup
    condition: always()
